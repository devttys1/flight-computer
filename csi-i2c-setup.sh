#!/bin/sh
 
#Reset CSI chip manually 
echo 7 > /sys/class/gpio/export
echo "out" > /sys/class/gpio/gpio7/direction
echo 1 > /sys/class/gpio/gpio7/value
echo 0 > /sys/class/gpio/gpio7/value
echo "CSI reset active"
echo 1 > /sys/class/gpio/gpio7/value
echo "CSI reset released"
 
#Script for CSI camera input configuration via I2C2
 
I2C_BUS=1
IO_MAP_ADDR=0x4C # main I2C address for CSI chip
USE_16BIT=1
 
ADV7610_CHIP_ID_HIGH_BYTE=0xEA
ADV7610_CHIP_ID_LOW_BYTE=0xEB
MAX_LOCK_TRIES=1000
 
#8-bit address is used for addresses setup
CEC_MAP_ADDR_8BIT=0x80
INFOFRAME_MAP_ADDR_8BIT=0x7C
KSV_MAP_ADDR_8BIT=0x64
#EDID_MAP_ADDR_8BIT=0x6C
EDID_MAP_ADDR_8BIT=0x24
#HDMI_MAP_ADDR_8BIT=0x68
HDMI_MAP_ADDR_8BIT=0x28
CP_MAP_ADDR_8BIT=0x44
DPLL_MAP_ADDR_8BIT=0x4C
 
#7-bit address for i2cset is required
CEC_MAP_ADDR=0x40
INFOFRAME_MAP_ADDR=0x3E
KSV_MAP_ADDR=0x32
#EDID_MAP_ADDR=0x36
EDID_MAP_ADDR=0x12
#HDMI_MAP_ADDR=0x34
HDMI_MAP_ADDR=0x14
CP_MAP_ADDR=0x22
DPLL_MAP_ADDR=0x26
 
#We need here full 8-bit addresses
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xF4 $CEC_MAP_ADDR_8BIT || echo "Failed: cec map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xF5 $INFOFRAME_MAP_ADDR_8BIT || echo "Failed: infoframe map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xF8 $DPLL_MAP_ADDR_8BIT || echo "Failed: dpll map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xF9 $KSV_MAP_ADDR_8BIT || echo "Failed: ksv map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xFA $EDID_MAP_ADDR_8BIT || echo "Failed: edid map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xFB $HDMI_MAP_ADDR_8BIT || echo "Failed: hdmi map i2c address"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0xFD $CP_MAP_ADDR_8BIT || echo "Failed: cp map i2c address"
 
edid="0x00 0xFF 0xFF 0xFF 0xFF 0xFF 0xFF 0x00 0x06 0xD4 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x16 0x01 0x03 0x81 0x46 0x27 0x78 0x0A 0x32 0x30 0xA1 0x54 0x52 0x9E 0x26 0x0A 0x49 0x4B 0xA3 0x08 0x00 0x81 0xC0 0x81 0x00 0x01 0x01 0x81 0x40 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x01 0x00 0x00 0x00 0xFF 0x00 0x31 0x32 0x33 0x34 0x35 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xFC 0x00 0x33 0x44 0x52 0x0A 0x20 0x20 0x20 0x20 0x20 0x20 0x20 0x20 0x20 0x00 0x00 0x00 0xFD 0x00 0x38 0x4B 0x20 0x44 0x11 0x00 0x0A 0x20 0x20 0x20 0x20 0x20 0x20 0x01 0xB2 0x02 0x03 0x16 0x70 0x42 0x04 0x3E 0x26 0x15 0x07 0x50 0x09 0x07 0x01 0x67 0x03 0x0C 0x00 0x10 0x00 0x00 0x1E 0x01 0x1D 0x00 0x72 0x51 0xD0 0x1E 0x20 0x6E 0x28 0x55 0x00 0xC4 0x8E 0x21 0x00 0x00 0x1E 0x8C 0x0A 0xD0 0x8A 0x20 0xE0 0x2D 0x10 0x10 0x3E 0x96 0x00 0xC4 0x8E 0x21 0x00 0x00 0x18 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xA3"
 
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x6C 0xA0 || echo "Failed: Set the AUTO_EDID to turn on when the internal EDID is enabled"
 
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x77 0x00 || echo "Failed: Disable the Internal EDID"
 
i=0
#Set the EDID value
for byte in $edid
do
 #echo $I2C_BUS $EDID_MAP_ADDR $i $byte
 i2cset -y $I2C_BUS $EDID_MAP_ADDR $i $byte || printf "Failed: EDID byte 0x%x\n" $i
 i=$(($i + 1))
done
 
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x77 0x00 || echo "Failed: Set the Most Significant Bit of the SPA location to 0"
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x52 0x20 || echo "Failed: Set the SPA for port B. 0x52"
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x53 0x00 || echo "Failed: Set the SPA for port B. 0x53"
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x70 0x9E || echo "Failed: Set the Least Significant Byte of the SPA location"
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x74 0x03 || echo "Failed: Enable the Internal EDID for Ports"
 
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x00 0x00 || echo "Failed: Select port A (shouldnt matter, only 1 port)"
 
if [ $USE_16BIT -eq 1 ]; then
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x03 0x80 || echo "Failed: 16-bit SDR ITU-656 mode"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x19 0x89 || echo "Failed: IO_MAP_ADDR 0x19"
else
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x03 0x00 || echo "Failed: 8-bit SDR ITU-656 mode"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x19 0xC0 || echo "Failed: Enable LLC DLL, double clock"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x33 0x40 || echo "Failed: Enable LLC_DLL_MUX"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x06 0xA1 || echo "Failed: Invert CLK"
fi
 
#i2cset -y $I2C_BUS $IO_MAP_ADDR 0x14 0x7F || echo "Failed: Max Drive Strength"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x14 0x55 || echo "Failed: med-low drive strength (including clock)"
i2cset -y $I2C_BUS $CP_MAP_ADDR 0xBA 0x01 || echo "Failed: Set HDMI FreeRun"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x0B 0x44 || echo "Failed: Power up part 1"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x0c 0x42 || echo "Failed: Power up part 2"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x15 0xB8 || echo "Failed:Disable Tristate of clock and data"
 
i2cset -y $I2C_BUS $KSV_MAP_ADDR 0x40 0x81 || echo "Failed: Disable HDCP 1.1 features"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x9B 0x03 || echo "Failed: ADI recommended setting 0x9B"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC1 0x01 || echo "Failed: ADI recommended setting 0xC1"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC2 0x01 || echo "Failed: ADI recommended setting 0xC2"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC3 0x01 || echo "Failed: ADI recommended setting 0xC3"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC4 0x01 || echo "Failed: ADI recommended setting 0xC4"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC5 0x01 || echo "Failed: ADI recommended setting 0xC5"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC6 0x01 || echo "Failed: ADI recommended setting 0xC6"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC7 0x01 || echo "Failed: ADI recommended setting 0xC7"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC8 0x01 || echo "Failed: ADI recommended setting 0xC8"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xC9 0x01 || echo "Failed: ADI recommended setting 0xC9"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xCA 0x01 || echo "Failed: ADI recommended setting 0xCA"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xCB 0x01 || echo "Failed: ADI recommended setting 0xCB"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0xCC 0x01 || echo "Failed: ADI recommended setting 0xCC"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x00 0x00 || echo "Failed: Set HDMI Input Port A"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x83 0xFE || echo "Failed: Enable clock terminator for port A"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x6F 0x08 || echo "Failed: ADI recommended setting 0x6F"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x85 0x1F || echo "Failed: ADI recommended setting 0x85"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x87 0x70 || echo "Failed: ADI recommended setting 0x87"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x8D 0x04 || echo "Failed: LFG"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x8E 0x1E || echo "Failed: HFG"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x1A 0x8A || echo "Failed: unmute audio"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x57 0xDA || echo "Failed: ADI recommended setting 0x57"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x58 0x01 || echo "Failed: ADI recommended setting 0x58"
i2cset -y $I2C_BUS $HDMI_MAP_ADDR 0x75 0x10 || echo "Failed: DDC drive strength"
 
#i2cset -y 1 0x14 0x83 0xFD #termination
 
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x1 0x6 || echo "Failed: Prim_Mode =110b HDMI-GR"
i2cset -y $I2C_BUS $IO_MAP_ADDR 0x2 0xF5 || echo "Failed: Auto CSC, RGB out, Set op_656 bit"
 
#Free run should be black, not blue
i2cset -y $I2C_BUS $CP_MAP_ADDR 0xBF 0x16 || echo "Failed: Turn on DEF_COL_MAN_VAL"
#default i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC0 0x00 || echo "Failed: Free run color CHA (Y)"
i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC0 0x00 || echo "Failed: Free run color CHA (Y)"
#default i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC1 0x80 || echo "Failed: Free run color CHB (U)"
i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC1 0x66 || echo "Failed: Free run color CHB (U)"
#default i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC2 0x80 || echo "Failed: Free run color CHC (V)"
i2cset -y $I2C_BUS $CP_MAP_ADDR 0xC2 0x66 || echo "Failed: Free run color CHC (V)"
